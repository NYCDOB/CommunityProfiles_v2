<!DOCTYPE html>
<!-- 
requirements:
style2.css

-->
<!-- 
Date: Aug 2019
Map control for Community Profile append
-->
<head>
    <title>Community Profiles</title>
    <link rel="stylesheet" href="style2.css" type="text/css" media="screen" />
		<style>
			.legend {
				font-size: 12px;
			}
			.floor {
				  fill: #d6d6d6;
			  }
			#divMapError  {
					color: red;
					font-weight: bold;
					font-size: 1.1em;
					display: none;
					padding:15px ;
					margin: 15% 15%;
					font-size:2em;
					word-wrap: break-word;
			}  
		</style>
	
</head>
<div id="main-wrapper">

	<div id="divMapError">		<p></p>		</div> 
	
	<!--   div id="noData" style="display:none;"> <h2>No Data Available</h2> </div>  <!--  shown for empty dataset -->
	<div id="noData" style="display:none;"> <h2>No Data Available</h2> </div>  <!--  shown for empty dataset -->
	
	<div id="metrics" style="visibility:hidden;" >
    <div id="motor" style="visibility:'hidden';">
        <h2 style="margin-top:5px; margin-left:15px; font-size:18px;"></h2>
		<br>
		<h3 style="font-size:14px; margin-left:15px;">CITYWIDE AVERAGE: <font color="#e21d1d"><span id="citiAvg"></span></font> WORKDAYS</h3>
		<h3 style="font-size:14px; margin-left:15px;">CD <font color="#e21d1d"><span id="maxCD"></span></font> HAS THE HIGHEST AVERAGE AGE (<font color="#e21d1d"><span id="maxAvg"></span></font>) </h3>
		<h3 style="font-size:14px; margin-left:15px;">DATA UPDATED ON <font color="#e21d1d"><span id="today"></span></font></h3>
    </div>
    <div class="clr"></div>
</div><!-- @end #metrics -->    
		

<div id="tooltip" class="tooltip">
    <h3 class="name"></h3>
	    <div data-metric="AvgAge" class="line">
			Total:
			<div class="AvgAge_val val"></div>
		</div>
		
		<div data-metric="Measure1" class="line">
			Percentile:
			<div class="Measure1_val val"></div>
		</div>
		<div data-metric="Measure2" class="line">
			Measure 2 (tbd):
			<div class="Measure2_val val"></div>
		</div>

</div>   


<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-format.v1.min.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

<script>


let mapColors=["#D3E5E8","#B8D0D9","#9CBAC9","#81A5BA","#658FAB","#4A7A9B","#2E648C"]

//var width = 1064,
var width = window.parent.document.querySelector(".chart-wrapper").clientWidth, 
    height = 768,
    center = [width / 2, height / 2],
    defaultFill = "#E1E1E1";

var projection = d3.geo.mercator()
    .scale(75000)
	.center( [-73.94,40.70] ) 
    .translate([width / 2, height / 2]);
	
var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body #main-wrapper").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g");
		
svg.on("wheel.zoom", null);
svg.on("mousewheel.zoom", null);
svg.append("rect")
    .attr("class", "overlay")
    .attr("width", width)
    .attr("height", height);
svg.append("svg:image")
    .attr("xlink:href", "images/progress-anim.gif")
    .attr("id", "progress-image")
    .attr("width", 43)
    .attr("height", 11)
    .attr("x", width / 2)
    .attr("y", height / 2);
	



var g = svg.append("g");

var tooltip = d3.select("#tooltip")
 .attr("class", "tooltip")
 .style("opacity", 0);
var CURR_SELECT = ["count","totalCount"];
var COMP_CNT = ["ComplaintCount"];

function assignButtonHandlers() {
		let metricbuttons = window.parent.document.querySelectorAll(".dropdown button");
		//grab the buttons in the parent window
		//requirement:
		//the id of the button must follow convention: "active"+[metricname]+"dataset"
		//		e.g. activeSheddataset
		// this same id is the name of the variable that holds the info about the metric
		// 		e.g.: activeSheddataset= 
		//					   "citiAvg": citiAvg,   
		//					   "maxCD" :  maxCD,     
		//					   "maxAvg" : maxAvg, 
		//					   "percentiles": thePercentiles, 
		//					   "svgDataSet" :  currentMetric,  //is the id of the <g> element 
		//					   "metricName" :  metricName
		for ( let ctr=0;  ctr < metricbuttons.length ; ctr++) {
				$(metricbuttons[ctr]).click( function (e) { 
							e.preventDefault; 

							let varErrorDiv=window.frames.document.querySelector("#main-wrapper #noData") 
							if (  !!(window.frames[e.target.id]) ) {  //if a matching dataset, show the map
									window.frames.document.querySelector("."+e.target.id).style.visibility="visible"
									varErrorDiv.style.display="none"
									window.frames.document.querySelector("svg").style.visibility="visible"
									
							}  else  {
									varErrorDiv.style.display="block"
									window.frames.document.querySelector("svg").style.visibility="hidden"
									
							}
							classNamesToHide = window.frames.document.querySelectorAll(  "g [class^='active']:not(."+e.target.id+")" );
							classNamesToHide.forEach( (svgNode) =>
										{svgNode.style.visibility="hidden";})
				})
		}  // end parent button handler
}

function getToday() {
	let today = new Date();
	let dd = today.getDate();
	let mm = today.getMonth()+1;
	let yyyy = today.getFullYear();
	return (mm + '/' + dd + '/' + yyyy);
}

// click event handler was used when map was standalone page.
<!-- $(".metricSwitch").click((e) =>  -->
	<!-- {   e.preventDefault(); -->
		<!-- document.querySelector("#motor h2").innerHTML=this[e.target.id].metricName; -->
		<!-- d3.select("#citiAvg").html(d3.format(".1f")(this[e.target.id].citiAvg));		 -->
		<!-- d3.select("#maxAvg").html(this[e.target.id].maxAvg); -->
		<!-- d3.select("#maxCD").html(this[e.target.id].maxCD); -->
		<!-- d3.select("#today").html(getToday()); -->
		<!-- document.querySelector("."+this[e.target.id].svgDataSet).style.visibility="visible" -->
		<!-- let otherBtns = document.querySelectorAll("button:not(#"+e.target.id+")") -->
		<!-- otherBtns.forEach((el)=>{(this[el.id].svgDataSet)?document.querySelector("."+this[el.id].svgDataSet).style.visibility="hidden": null; -->
		<!-- }) -->
	<!-- }) -->
function getPercentiles(dataArray, measureColumn)	{
	let retval = []; 
	let varname=""; 
	let numPercentiles=7;
	let percentileNames=[];
	let percentileRange = Math.floor(100/numPercentiles);

	//filter() to remove 0s from sorted array
	let sortedData = dataArray.sort(function(a,b){return a[measureColumn] - b[measureColumn]})
			.map( 	 (el) => { return el[measureColumn]}  ).filter( function(val) { return val >0}      )

	for (let myctr=percentileRange; myctr <= 100; myctr+=percentileRange) {
		percentileNum = Math.floor(myctr);
		varname="percentile"+percentileNum;
		percentileNames.push(varname)
		this[varname] = d3.quantile(sortedData,   percentileNum/100); 
		retval.push(this[varname]);
	}

	retval[ retval.length-1 ]=parseFloat(sortedData[sortedData.length-1])
	dataArray.forEach( function(dataRow) {
		dataRow["Percentile"] = function () {
				let percentile=0;
				let foundPercentile=false;
				for (let myctr=0; myctr < percentileNames.length-1; myctr++) {
						if ( dataRow[measureColumn] <= this[percentileNames[myctr]]       )       {
							percentile = parseInt(percentileNames[myctr].substring(10));
							foundPercentile=true;
							break;
						}
				}
				return (foundPercentile)?percentile: 100;
			}()										
	})
	return retval;
}

function processDataset(datasetToProcess, currentMetric, CD_topoJSON, metricName) {
	let commuteById = d3.map();
	datasetToProcess.forEach(function(d) { 
		commuteById.set(d.communityBoard, d);
	});
	let thePercentiles = getPercentiles(datasetToProcess, CURR_SELECT[0]);
	let citiAvg = d3.mean(datasetToProcess, function(d) {return d[CURR_SELECT[0]];});
	let minAvg = d3.min(datasetToProcess, function(d) {return d[CURR_SELECT[0]];});
	let maxAvg = d3.max(datasetToProcess, function(d) {return d[CURR_SELECT[0]]; });
	let maxCD = datasetToProcess.filter (function(d) {
		if (d[CURR_SELECT[0]] == maxAvg) {
			return d[CURR_SELECT[0]];  
		}})[0].communityBoard;  //CD with highest count
	this[currentMetric+"Stats"] = { 
	"city_avg": citiAvg, 
	"min_avg":minAvg, 
	"max_avg":maxAvg, 
	"highest_cd":maxCD	}
	g.append("g")
		.attr("class", currentMetric)
		.attr("visibility", "hidden") 
		.selectAll("path")
					.data(topojson.feature(CD_topoJSON, CD_topoJSON.objects.collection).features)
		.enter()
				.append("path")
				.attr("d", path)
				.on("mouseover", function(d) {
						d3.select(this.parentNode.appendChild(this)).classed("selected", true);
						tooltip.transition().duration(100)
						.style("opacity", 1)
						if (d3.event.pageX > (width - 200)) {
							tooltip.style("left", (d3.event.pageX - 210) + "px");
						} else {
							tooltip.style("left", (d3.event.pageX + 20) + "px")
							.style("top", (d3.event.pageY -30) + "px");
						}
						if (d3.event.pageY > (height - 150)) {
							tooltip.style("top", (d3.event.pageY -140) + "px");
						} else {
							tooltip.style("top", (d3.event.pageY -30) + "px");
						}
						let commdistrict =d.id;
						let boros=["Boro?","Manhattan","Bronx", "Brooklyn","Queens","Staten Island"]
						d.newBoro=boros[(''+d.id).substr(0,1)]
						tooltip.select(".name").text("CD: "+commdistrict+", "+ d.newBoro ) ;
						document.querySelector('.line[data-metric="AvgAge"] ').childNodes[0].nodeValue="Total " + metricName + ":"		
						tooltip.select(".AvgAge_val.val").text(   (commuteById.get(d.id) == undefined) ? "0": commuteById.get(d.id)["count"]     )

						// other measures will be added to tooltip here. Must account for no match in "metric".json file
//						tooltip.select(".Measure1_val.val").text(   (commuteById.get(d.id) == undefined ) ? "n/a":commuteById.get(d.id)["Percentile"]    )
						tooltip.select(".Measure1_val.val").text((commuteById.get(d.id) != undefined && commuteById.get(d.id)["count"] != 0 )?commuteById.get(d.id)["Percentile"]: "n/a")

				})
		  .on("mouseout", function() {
				d3.select(this).classed("selected", false);
				tooltip.transition().duration(300)
				.style("opacity", 0);
				});
			  
	let color = d3.scale.linear()  //NOT USED; SEE COLOR2()
		.domain(  [minAvg,maxAvg] )
		.range(["#D3E5E8", "#2E648C"])
		.interpolate(d3.interpolateLab);	
				
	svg.selectAll("."+currentMetric+" path")
		.attr("fill", function(d) {
			if (commuteById.get(d.id) != undefined) {
				let val = commuteById.get(d.id)[CURR_SELECT[0]];
				for (let ctr=0; ctr < thePercentiles.length; ctr++) {
					if ( val <= thePercentiles[ctr] ) {  //find the percentile this value falls in
						return (val) ? mapColors[ctr] : "#d6";  //if val is 0, fill color is grey
					}
				}
			} else  {
				return "#00"
			}
		});
		globalPercentiles=[...thePercentiles];   //this will be used for the legend, so we make it a var
		return ( {
	   "citiAvg": citiAvg,
	   "maxCD" :  maxCD, 
	   "maxAvg" : maxAvg, 
	   "percentiles": thePercentiles, 
	   "svgDataSet" :  currentMetric,
	   "metricName" :  metricName
	   })
}

function handleError(errString,notifyType="console") {
	(notifyType=="alert") ? alert(errString) : console.log(errString);
	return null;
}




queue()
	// .defer(d3.json, "data/CD_toJoin_topoJSON.json")  //no longer used; will have all comm districts 
    .defer(d3.json, "data/CD_topoJSON.json")
	.defer(d3.json, "data/activeAHVsSummary.json" )
	.defer(d3.json, "data/activeShedsSummary.json")
	.defer(d3.json, "data/activePermitSummary.json")	
    .await(ready);  // this can be more dynamic by adding property to json to indicate which metric.
function ready(error,CD_topoJSON, activeahv, activeshed,activepermit) {  	
		//NOTE: if there is an issue with any d3.json, all will fail.
		// an error is displayed and no maps are rendered.
		svg.select("#progress-image").remove();	
		if (error) {  //handle error and exit function immediately
			let varErrorDiv=document.querySelector("#divMapError p") 
			let fileError= error.responseURL.substring( error.responseURL.lastIndexOf("/")+1   )			
			varErrorDiv.innerHTML="Error rendering maps: "+error.statusText;
			varErrorDiv.parentElement.style.display="block"
			handleError("Error(s) reading json datasets.\n\n"+error.statusText+"\n"+fileError+"\nContact Dev Squad 212-555-1212", "console" )
			return;
		}
		// *dataset variable name must match id of button to control metric's visibility
		// processDataset() function takes args:
				// 1. name of dataset returned from d3.defer and defined in ready() arguments
				// 2. classname string to use for <g> element, must match button id in parent html
				// 3. d3.json topojson result set
				// 4. metric name string used <h2>
		activeAVHdataset=     (activeahv.length) ? processDataset(activeahv,   "activeAVHdataset",    CD_topoJSON, "AHVs") : handleError("No ahv data");
		activeSheddataset=    (activeshed.length) ? processDataset(activeshed,  "activeSheddataset",   CD_topoJSON, "Sheds") : handleError("No shed data");
		activePermitdataset = (activepermit.length) ? processDataset(activepermit,"activePermitdataset", CD_topoJSON, "Permits") : handleError("No permit data"); //default layer
		assignButtonHandlers();
		//var ext_color_domain = [minAvg, 10.6, 13.2, 14.6, 15.3, 16.2, maxAvg] 
		let ext_color_domain = globalPercentiles;  //globalPercentils is set in processDataset()
		
		//let legend_labels = activePermitdataset.percentiles.map((el,index,arr)=>(index==0)? "LOW" : (index==arr.length-1) ? "HIGH" : "")
		let legend_labels = globalPercentiles.map((el,index,arr)=>(index==0)? "LOW" : (index==arr.length-1) ? "HIGH" : "")
		let legend = svg.selectAll("g.legend")
			.data(ext_color_domain)
			.enter().append("g")
			.style("font-size", "16px")
			.style("font-family", "Arial, Helvetica, sans-serif")
			.attr("class", "legend");

		let color2 = d3.scale.linear()
			.domain(  [  ext_color_domain[0],ext_color_domain[ext_color_domain.length-1]  ] )  //max & min values
			.range([mapColors[0],mapColors[mapColors.length-1]])
			.interpolate(d3.interpolateLab);

		let ls_w = 25, ls_h = 25;
		legend.append("rect")
			.attr("x", 10)
			.attr("y", function(d, i){return height - (i*ls_h) - (-1*ls_h);})
			.attr('transform', 'translate(10, -630)') //XY position of legend
			.attr("width", ls_w)
			.attr("height", ls_h)
			.style("fill", function(d, i){
				return (d) ? color2(d)  :"#d6d6d6";
				})
			.style("opacity", 1);

		legend.append("text")
			.attr("x", 40)
			.attr("y", function(d, i){return height - (i*ls_h) - ls_h - (-69);})
			.attr('transform', 'translate(10, -630)') // XY position of legend
			.text(function(d, i){return legend_labels[i];});
		d3.select(self.frameElement).style("height", height + "px");
		
		window.parent.document.querySelector(".dropdown button.active").click();
}
</script>
